/* 1 */
{
    "_id": "FODvL6hY",
    "data": [{
        "_id": "U$7M9w60",
        "active": true,
        "createdOn": ISODate("2020-01-03T04:05:04.318Z"),
        "meterSerialNumberID": "eWhH6LE4",
        "assignTenant": true,
        "tenantID": "FODvL6hY",
        "createdBy": "8tJ9RVNV",
        "__v": 0,
        "userDetails": {
            "_id": "8tJ9RVNV",
            "isActive": true,
            "createdOn": ISODate("2019-11-19T05:22:30.573Z"),
            "name": "Saikiran",
            "username": "Sai",
            "email": "sai@gmail.com",
            "password": "$2a$10$PZWiz7VbmMkBl0anwC/QmO1U2ja8EGHQBsopfrvPbRdmegBBvuMrq",
            "confirmPassword": "test@123",
            "role": "Super Admin",
            "phone": "9090909090",
            "address": "hyderabad",
            "__v": 0
        },
        "meterdet": {
            "_id": "eWhH6LE4",
            "active": true,
            "createdOn": ISODate("2019-12-19T17:22:32.812Z"),
            "meterSerialNumber": "1234",
            "model": "23",
            "meterType": "u0RCOPry",
            "deptMeterNumberID": "wjogkLgz",
            "sourceType": "LlpQitXd",
            "panel": "",
            "gateway": "Mqchtl1F",
            "provider": "",
            "multifyingFactor": 12,
            "comments": "",
            "createdBy": "8tJ9RVNV",
            "__v": 0
        }
    }],
    "tenentdet": {
        "_id": "FODvL6hY",
        "active": true,
        "createdOn": ISODate("2019-12-19T17:25:17.257Z"),
        "tenantName": "vijay",
        "contactPersonName": "Vijay Kumar",
        "contactNumber": "",
        "email": "",
        "comments": "",
        "createdBy": "8tJ9RVNV",
        "__v": 0
    }
}

/* 2 */
{
    "_id": "chiller",
    "data": [{
        "_id": "wKFAgasX",
        "active": true,
        "createdOn": ISODate("2020-01-03T04:05:21.403Z"),
        "meterSerialNumberID": "FUw6jwuM",
        "assignTenant": false,
        "tenantID": "chiller",
        "createdBy": "8tJ9RVNV",
        "__v": 0,
        "userDetails": {
            "_id": "8tJ9RVNV",
            "isActive": true,
            "createdOn": ISODate("2019-11-19T05:22:30.573Z"),
            "name": "Saikiran",
            "username": "Sai",
            "email": "sai@gmail.com",
            "password": "$2a$10$PZWiz7VbmMkBl0anwC/QmO1U2ja8EGHQBsopfrvPbRdmegBBvuMrq",
            "confirmPassword": "test@123",
            "role": "Super Admin",
            "phone": "9090909090",
            "address": "hyderabad",
            "__v": 0
        },
        "meterdet": {
            "_id": "FUw6jwuM",
            "active": true,
            "createdOn": ISODate("2019-12-13T18:57:32.807Z"),
            "meterSerialNumber": "gsggwre",
            "model": "wyweywery",
            "meterType": "u0RCOPry",
            "deptMeterNumberID": "lqYZ7@Ze",
            "sourceType": "LlpQitXd",
            "panel": "sPcBRm5q",
            "gateway": "yryryy",
            "provider": "yreyrey",
            "multifyingFactor": 43432432432.0,
            "comments": "4rtgfdgfdgfd",
            "createdBy": "8tJ9RVNV",
            "__v": 0
        }
    }]
}

/* 3 */
{
    "_id": "Is5Ie67g",
    "data": [{
            "_id": "6qixUVbt",
            "active": true,
            "createdOn": ISODate("2020-01-03T04:04:17.026Z"),
            "meterSerialNumberID": "3WnCVlHg",
            "assignTenant": true,
            "tenantID": "Is5Ie67g",
            "createdBy": "8tJ9RVNV",
            "__v": 0,
            "userDetails": {
                "_id": "8tJ9RVNV",
                "isActive": true,
                "createdOn": ISODate("2019-11-19T05:22:30.573Z"),
                "name": "Saikiran",
                "username": "Sai",
                "email": "sai@gmail.com",
                "password": "$2a$10$PZWiz7VbmMkBl0anwC/QmO1U2ja8EGHQBsopfrvPbRdmegBBvuMrq",
                "confirmPassword": "test@123",
                "role": "Super Admin",
                "phone": "9090909090",
                "address": "hyderabad",
                "__v": 0
            },
            "meterdet": {
                "_id": "3WnCVlHg",
                "active": false,
                "createdOn": ISODate("2019-11-30T14:04:26.242Z"),
                "meterSerialNumber": "123meter456",
                "model": "model",
                "meterType": "type123",
                "deptMeterNumberID": "DmnWcP$J",
                "sourceType": "source",
                "panel": "panel",
                "gateway": "hgghh",
                "provider": "jhhjjh",
                "multifyingFactor": 8,
                "comments": "haiiiiiiiii",
                "createdBy": "8tJ9RVNV",
                "__v": 0,
                "updatedBy": "b8O3bNsW",
                "updatedOn": ISODate("2019-11-30T17:50:23.548Z"),
                "removedBy": "8tJ9RVNV",
                "removedOn": ISODate("2019-11-30T15:08:29.860Z")
            }
        },
        {
            "_id": "jgAertPP",
            "active": true,
            "createdOn": ISODate("2020-01-03T04:04:33.787Z"),
            "meterSerialNumberID": "4VeWmvhW",
            "assignTenant": true,
            "tenantID": "Is5Ie67g",
            "createdBy": "8tJ9RVNV",
            "__v": 0,
            "userDetails": {
                "_id": "8tJ9RVNV",
                "isActive": true,
                "createdOn": ISODate("2019-11-19T05:22:30.573Z"),
                "name": "Saikiran",
                "username": "Sai",
                "email": "sai@gmail.com",
                "password": "$2a$10$PZWiz7VbmMkBl0anwC/QmO1U2ja8EGHQBsopfrvPbRdmegBBvuMrq",
                "confirmPassword": "test@123",
                "role": "Super Admin",
                "phone": "9090909090",
                "address": "hyderabad",
                "__v": 0
            },
            "meterdet": {
                "_id": "4VeWmvhW",
                "active": true,
                "createdOn": ISODate("2019-11-30T15:04:31.318Z"),
                "meterSerialNumber": "meter456",
                "model": "model123",
                "meterType": "new",
                "deptMeterNumberID": "yOSx5$Sf",
                "sourceType": "new source",
                "panel": "test",
                "gateway": "test",
                "provider": "saas",
                "multifyingFactor": 3,
                "comments": "testing",
                "createdBy": "8tJ9RVNV",
                "__v": 0,
                "updatedBy": "8tJ9RVNV",
                "updatedOn": ISODate("2019-11-30T15:05:58.129Z")
            }
        },
        {
            "_id": "PcnqWeU5",
            "active": true,
            "createdOn": ISODate("2020-01-03T04:04:49.928Z"),
            "meterSerialNumberID": "FUw6jwuM",
            "assignTenant": true,
            "tenantID": "Is5Ie67g",
            "createdBy": "8tJ9RVNV",
            "__v": 0,
            "userDetails": {
                "_id": "8tJ9RVNV",
                "isActive": true,
                "createdOn": ISODate("2019-11-19T05:22:30.573Z"),
                "name": "Saikiran",
                "username": "Sai",
                "email": "sai@gmail.com",
                "password": "$2a$10$PZWiz7VbmMkBl0anwC/QmO1U2ja8EGHQBsopfrvPbRdmegBBvuMrq",
                "confirmPassword": "test@123",
                "role": "Super Admin",
                "phone": "9090909090",
                "address": "hyderabad",
                "__v": 0
            },
            "meterdet": {
                "_id": "FUw6jwuM",
                "active": true,
                "createdOn": ISODate("2019-12-13T18:57:32.807Z"),
                "meterSerialNumber": "gsggwre",
                "model": "wyweywery",
                "meterType": "u0RCOPry",
                "deptMeterNumberID": "lqYZ7@Ze",
                "sourceType": "LlpQitXd",
                "panel": "sPcBRm5q",
                "gateway": "yryryy",
                "provider": "yreyrey",
                "multifyingFactor": 43432432432.0,
                "comments": "4rtgfdgfdgfd",
                "createdBy": "8tJ9RVNV",
                "__v": 0
            }
        }
    ],
    "tenentdet": {
        "_id": "Is5Ie67g",
        "active": true,
        "createdOn": ISODate("2019-11-30T07:43:32.474Z"),
        "tenantName": "saikiran11",
        "contactPersonName": "kiran11",
        "contactNumber": "9890909090",
        "email": "examp11le@gmail.com",
        "comments": "added111 by me test",
        "createdBy": "8tJ9RVNV",
        "__v": 0,
        "updatedBy": "8tJ9RVNV",
        "updatedOn": ISODate("2019-12-02T05:02:21.601Z")
    }
}


db.getCollection('metertenants').aggregate([

    {
        $lookup: {
            from: "users",
            let: {
                "user": "$createdBy"
            },
            pipeline: [{
                $match: {
                    $expr: {
                        $and: [{
                            $eq: ["$_id", "$$user"]
                        }, ]
                    }
                }
            }, {
                $project: {
                    username: 1
                }
            }],
            as: "userDetails"
        }
    },
    {
        $unwind: {
            path: "$userDetails",
            preserveNullAndEmptyArrays: true
        }
    },


    {
        $lookup: {
            from: "meters",
            let: {
                "meter": "$meterSerialNumberID"
            },
            pipeline: [{
                $match: {
                    $expr: {
                        $and: [{
                            $eq: ["$_id", "$$meter"]
                        }, ]
                    }
                }
            }],
            as: "meterdet"
        }
    },
    {
        $unwind: {
            path: "$meterdet",
            preserveNullAndEmptyArrays: true
        }
    },
    {
        $group: {
            _id: "$tenantID",
            data: {
                $push: "$$ROOT"
            }
        }
    },
    {
        $lookup: {
            from: "tenants",
            let: {
                "tenant": "$_id"
            },
            pipeline: [{
                $match: {
                    $expr: {
                        $and: [{
                            $eq: ["$_id", "$$tenant"]
                        }, ]
                    }
                }
            }],
            as: "tenentdet"
        }
    },
    {
        $unwind: {
            path: "$tenentdet",
            preserveNullAndEmptyArrays: true
        }
    },


])